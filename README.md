# –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è

- –°–ª–æ—Ç (Slot) - —Ö—Ä–∞–Ω–∏–ª–∏ –ø–∞—Ä—ã –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ
- –ì—Ä—É–ø–ø–∞ (Group) - –ì—Ä—É–ø–ø–∞ –∏–∑ 8-–∏ —Å–ª–æ—Ç–æ–≤ + –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ
- –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ (Control word) - 8-–º–∏ –±–∞–π—Ç–Ω–æ–µ —Å–ª–æ–≤–æ. –ö–∞–∂–¥—ã–π –±–∞–π—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –±–∞–π—Ç —Å–ª–æ—Ç–∞.
- –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –±–∞–π—Ç(Control byte) - 8-–∏ –±–∏—Ç–Ω–æ–µ —á–∏—Å–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 7 –±–∏—Ç —Ö—ç—à–∞ –∏ 1 –±–∏—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–π –≥–æ–≤–æ—Ä–∏—Ç –Ω–∞–º, –æ —Ç–æ–º, —á—Ç–æ —Å–ª–æ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω, –ø—É—Å—Ç –∏–ª–∏ —É–¥–∞–ª—ë–Ω.
- H1 - –°—Ç–∞—Ä—à–∏–µ 57 –±–∏—Ç —Ö—ç—à–∞.
- H2 - –ú–ª–∞–¥—à–∏–µ 7 –±–∏—Ç —Ö—ç—à–∞.
- –¢–∞–±–ª–∏—Ü–∞ - –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ö—ç—à —Ç–∞–±–ª–∏—Ü—ã - "Swiss Table". –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –æ–¥–Ω–æ–π –∏–ª–∏ –±–æ–ª–µ–µ –≥—Ä—É–ø–ø –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ç–∞–±–ª–∏—Ü–µ–π –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –º–∞–ø—É.
- –ú–∞–ø–∞ (Map) - –í–µ—Ä—Ö–Ω–µ-—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ç–∏–ø Map —Å–æ—Å—Ç–æ—è—â–∏–π –∏–∑ –Ω—É–ª—è –∏–ª–∏ –±–æ–ª–µ–µ —Ç–∞–±–ª–∏—Ü.
  –°—Ç–∞—Ä—à–∏–µ –±–∏—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç, –∫–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ö—ç—à.
- –•—Ä–∞–Ω–∏–ª–∏—â–µ(Directory) - –ú–∞—Å—Å–∏–≤ —Ç–∞–±–ª–∏—Ü, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–∞–ø–æ–π (Map)

![mapStruct.png](assets/mapStruct.png)

![controlWordStruct.png](assets/controlWordStruct.png)

–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –∫–∞–∂–¥—ã–π —Å–ª–æ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –±–∞–π—Ç, –Ω–æ —Å–≤—è–∑–∞–Ω —Å –Ω–∏–º —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ.

–ù–∞–ª–∏—á–∏–µ –±–∏—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –≤–≤–æ–¥–∏—Ç —Ç–∞–∫–∏–µ –ø–æ–Ω—è—Ç–∏—è, –∫–∞–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ª–æ—Ç–∞:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (Used)
- –ü—É—Å—Ç(Empty)
- –£–¥–∞–ª—ë–Ω(Deleted = Tombstone ü™¶)

![controlByteStatus.png](assets/controlByteStatus.png)

–ü–æ–Ω–∏–º–∞–Ω–∏–µ —ç—Ç–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–∏—Å–∫–∞, –≤—Å—Ç–∞–≤–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –º–∞–ø—ã.

# SIMD –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–≠—Ç–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–ª–æ—Ç–∞ –ø–æ —Ö—ç—à—É –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã. –û—Å–Ω–æ–≤–Ω–∞—è –µ—ë –º–æ—â—å –≤ —Ç–æ–º, —á—Ç–æ —Ç–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –Ω–µ –ø–µ—Ä–µ–±–∏—Ä–∞—Ç—å –∫–∞–∂–¥—ã–π —Å–ª–æ—Ç –≤ –≥—Ä—É–ø–ø–µ, –∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Ö—ç—à–∞(H2) –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∫–æ –≤—Å–µ–º 8-–∏ —Å–ª–æ—Ç–∞–º –≥—Ä—É–ø–ø—ã –∑–∞ –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é.

–°—Ç–∞—Ç—å—è –Ω–∞ [–≤–∏–∫–∏–ø–µ–¥–∏–∏](https://en.wikipedia.org/wiki/Single_instruction,_multiple_data) –ø—Ä–æ SIMD

# C–ø–ª–∏—Ç —Ö—ç—à–∞

![hashSplit.png](assets/hashSplit.png)

–ü—Ä–µ–¥—Å—Ç–∞–≤–∏–º, —á—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏ hash:
```
h = 0xABCDEF1234
```

–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –¥–≤–æ–∏—á–Ω—É—é —Ñ–æ—Ä–º—É
```
0xABCDEF1234 = 1010101111001101111011110001001000110100
```

```
H2 = 101010 (–ø–µ—Ä–≤—ã–µ 7 –±–∏—Ç)
H1 = 111001101111011110001001000110100 (–æ—Å—Ç–∞–≤—à–∏–µ—Å—è 57 –±–∏—Ç)
```

–ú–æ–∂–µ—Ç–µ –ø–æ–∏–≥—Ä–∞—Ç—å—Å—è –≤ cmd/hash_split.go (–ø–æ–ª—É—á–∏—Ç—å –¥–æ–≤–æ–ª—å–Ω–æ –ª–µ–≥–∫–æ H1 –∏ H2 c –ø–æ–º–æ—â—å—é –ø–æ–±–∏—Ç–æ–≤–æ–≥–æ —Å–¥–≤–∏–≥–∞).

–ê –≤–æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è h1 –∏ h2 –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤.
```go
func h1(h uintptr) uintptr {
	return h >> 7
}
```
```go
func h2(h uintptr) uintptr {
	return h & 0x7f
}
```

# –ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø—ã. –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–µ –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (Quadratic probing)

–û —Ç–æ–º, —á—Ç–æ —Ç–∞–∫–æ–µ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–µ –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–æ–∂–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å –≤ —Ç–æ–π –∂–µ [–≤–∏–∫–∏–ø–µ–¥–∏–∏](https://en.wikipedia.org/wiki/Quadratic_probing) –û—Å–Ω–æ–≤–Ω–∞—è –µ–≥–æ —Å—É—Ç—å (–Ω–∞–º –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è) - –∫–æ–≥–¥–∞ –º—ã –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ–º –ø–æ–∏—Å–∫, –≤—Å—Ç–∞–≤–∫—É –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ —Ö—ç—à —Ç–∞–±–ª–∏—Ü—ã - –º—ã –ø—Ä–æ—Ö–æ–¥–∏–º –Ω–µ –ø–æ –≤—Å–µ–º —Ç–∞–±–ª–∏—Ü–∞–º, –∞ —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—É—á–∏–ª–∏ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:

`p(i) := (i^2 + i)/2 + hash (mod mask+1)`

![qudraticProbing.png](assets/qudraticProbing.png)

–§—É–Ω–∫—Ü–∏—è –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–≥–æ –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–º –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–ø–ø, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –±—É–¥–µ–º –æ–±—Ö–æ–¥–∏—Ç—å, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Ö—ç—à–∞.

–û–±—Ä–∞—Ç–∏—Ç–µ **–≤–Ω–∏–º–∞–Ω–∏–µ**, —á—Ç–æ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–ª–æ—Ç–∞ –º—ã —Ä–∞–±–æ—Ç–∞–µ–º –Ω–µ —Å **—Ç–∞–±–ª–∏—Ü–∞–º–∏** –∞ —Å **–º–∞—Å—Å–∏–≤–æ–º –≥—Ä—É–ø–ø**.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤–≤–æ–¥–∏—Ç –Ω–∞–º –≤–∞–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è - —á–∏—Å–ª–æ –≥—Ä—É–ø–ø –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç–µ–ø–µ–Ω—å—é 2, –ø–æ—Å–ª–µ–¥–Ω—è—è –≥—Ä—É–ø–ø–∞ –≤ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–º –ø–æ–∏—Å–∫–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—É—Å—Ç–∞. (–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ 100%).

–ï—ë —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å [—Ç—É—Ç](https://cs.opensource.google/go/go/+/release-branch.go1.24:src/internal/runtime/maps/table.go) -> probeSeq
# –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞, –≤—Å—Ç–∞–≤–∫–∏, —É–¥–∞–ª–µ–Ω–∏—è

H1 - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥—Ä—É–ø–ø—ã, H2 - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ.
## –ü–æ–∏—Å–∫

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –ø–æ–ª—É—á–∏–ª–∏ H1 - —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å(probeSeq). –ú—ã –ø—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∏–Ω–¥–µ–∫—Å–∞–º –≥—Ä—É–ø–ø, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∏–∑ probeSeq (—Ç–æ –µ—Å—Ç—å –º—ã –ø—Ä–æ—Ö–æ–¥–∏–º –Ω–µ –ø–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º, –∞ —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –∏–∑ probSeq) –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º H2 —Å–æ –≤—Å–µ–º–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º–∏ –±–∞–π—Ç–∞–º–∏ –≥—Ä—É–ø–ø—ã –¥–æ —Ç–µ—Ö –ø–æ—Ä –ø–æ–∫–∞ –Ω–µ –Ω–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å–ª–æ—Ç.

- –ï—Å–ª–∏ —Å–ª–æ—Ç –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å Deleted(tomstone ü™¶), –æ–Ω –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –ø—É—Å—Ç–æ–π —Å–ª–æ—Ç(Empty), —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –±–æ–ª—å—à–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ –Ω–µ—Ç –∏ –ø–æ–∏—Å–∫ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è.
- –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –±–∞–π—Ç —Å —Ç–∞–∫–∏–º –∂–µ H2, —Ç–æ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞ —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º.
- –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∫–ª—é—á—É –∑–Ω–∞—á–µ–Ω–∏–µ.
- –í —Å–ª—É—á–∞–µ –ø—Ä–æ–≤–∞–ª–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
## –í—Å—Ç–∞–≤–∫–∞

–ê–ª–≥–æ—Ä–∏—Ç–º –≤—Å—Ç–∞–≤–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º—É –ø–æ–∏—Å–∫–∞, –Ω–æ —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏.
- –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è H2, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∫–ª—é—á—É –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤–æ–µ.
- –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω —Å–ª–æ—Ç –≤ —Å—Ç–∞—Ç—É—Å–µ Delted(tombstone). –î–∞–Ω–Ω—ã–π —Å–ª–æ—Ç –∑–∞–ø–æ–º–Ω–∏–∞–µ—Ç—Å—è, –∫–∞–∫ –≤–æ–∑–º–æ–∂–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏, –Ω–æ –ø–æ–∏—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–ª—é—á –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.
- –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω —Å–ª–æ—Ç –≤ —Å—Ç–∞—Ç—É—Å–µ Empty, —Ç–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ tombstone, –º—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–ª–æ—Ç tobstone, –∞ –ø—Ä–∏ –µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≤ —Å–ª–æ—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º Empty.
## –£–¥–∞–ª–µ–Ω–∏–µ

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤ –ø–æ–ª–Ω–æ–π –≥—Ä—É–ø–ø–µ —Å–ª–æ—Ç –Ω–µ –æ—Ç–º–µ—á–∞–µ—Ç—Å—è, –∫–∞–∫ –ø—É—Å—Ç–æ–π, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞ –ø—É—Å—Ç–æ–π —Å–ª–æ—Ç –º—ã –Ω–∞ –Ω—ë–º –æ—Å—Ç–∞–Ω–æ–≤–∏–º—Å—è, –≤ —Ç–æ –≤—Ä–µ–º—è, –∫–∞–∫ —É –Ω–∞—Å –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –ø—É—Å—Ç—ã–µ —Å–ª–æ—Ç—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≥—Ä—É–ø–ø–∞—Ö. –¢–∞–∫–∏–µ —Å–ª–æ—Ç—ã –ø–æ–º–µ—á–∞—é—Ç—Å—è, –∫–∞–∫ tombstone ü™¶(–Ω–∞–¥–≥—Ä–æ–±–∏–µ).  –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –Ω–µ –ø–æ–ª–Ω–æ–π –≥—Ä—É–ø–ø—ã, —Å–ª–æ—Ç –ø–æ–º–µ—á–µ—Ç—Å—è —Å—Ä–∞–∑—É, –∫–∞–∫ –ø—É—Å—Ç–æ–π.  –ù–∞–¥–≥—Ä–æ–±–∏—è –æ—á–∏—â–∞—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è —Ä–æ—Å—Ç–∞.

# –†–æ—Å—Ç –º–∞–ø—ã

–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥—Ä—É–ø–ø. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥—Ä—É–ø–ø –≤—Å–µ —Å–ª–æ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–æ–≤–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–æ–Ω–¥–æ–≤. –î—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –≤—Å—è —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∞ —Å—Ä–∞–∑—É.

–î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –º–∞–ø–∞ —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Å–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü. –ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ–π —Ö—ç—à-—Ç–∞–±–ª–∏—Ü–µ–π, –Ω–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ö—ç—à-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞. –†–æ—Å—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö, –ø–æ—ç—Ç–æ–º—É, —Ö–æ—Ç—è –≤—Å—è —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞—Å—Ç–∏ —Å—Ä–∞–∑—É, –∫–∞–∂–¥—ã–π –∏–∑ —ç—Ç–∏—Ö —Ä–æ—Å—Ç–æ–≤ —è–≤–ª—è–µ—Ç—Å—è –ª–∏—à—å –Ω–µ–±–æ–ª—å—à–æ–π —á–∞—Å—Ç—å—é –º–∞–ø—ã. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –¥–æ –µ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü.

–ú–∞–ø–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã. –î–æ 1024 —Ä–æ—Å—Ç –ø—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É –∑–∞–º–µ–Ω–æ–π —Å –¥–≤–æ–π–Ω–æ–π –µ–º–∫–æ—Å—Ç—å—é. –ó–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–µ–ª–∞ —Ä–æ—Å—Ç —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –¥–≤–µ.

–ú–∞–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "extensible hashing", —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å, –∫–∞–∫—É—é —Ç–∞–±–ª–∏—Ü—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å. –ú–∞—Å—Å–∏–≤ —Ç–∞–±–ª–∏—Ü –æ–±—Ä–∞–∑—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é("Directory"). –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ –≤–µ—Å—å —Ö—ç—à –∞ –ª–∏—à—å –≤–µ—Ä—Ö–Ω–∏–µ –±–∏—Ç—ã —Ö—ç—à–∞, –∫–∞–∫ –∏–Ω–¥–µ–∫—Å —Ç–∞–±–ª–∏—Ü—ã. –ß–∏—Å–ª–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –±–∏—Ç —Ä–∞—Å—Ç—ë—Ç –ø–æ –º–µ—Ä–µ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —á–∏—Å–ª–∞ —Ç–∞–±–ª–∏—Ü. –ù–∞–ø—Ä–∏–º–µ—Ä —É –Ω–∞—Å –≤—Å–µ–≥–æ –æ–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º 0 –±–∏—Ç —Ö—ç—à–∞. –ö–æ–≥–¥–∞ —É –Ω–∞—Å –¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º 1 –±–∏—Ç —Ö—ç—à–∞. Map.GlobalDepth - —ç—Ç–æ —á–∏—Å–ª–æ –±–∏—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã. 

–°—Ç–æ–∏—Ç –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ –∫–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ç—ë—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ. –û–Ω–∏ –∏–º–µ—é—Ç —Å–≤–æ–π load factor. –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ç—ë—Ç, –æ–Ω–∞ —Ä–∞–∑–¥–µ–ª—è–µ—Ç—Å—è. –ù–∞–º —É–∂–µ –Ω—É–∂–Ω–æ –¥–≤–∞ –±–∏—Ç–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –∏ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º—ã –∏–º–µ–µ–º —Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ã –∞ –Ω–µ 4-–µ. –ú—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —ç—Ç–æ, –ø–æ–∑–≤–æ–ª—è—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∏–Ω–¥–µ–∫—Å–∞–º —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Ç–∞–±–ª–∏—Ü—É. 

![mapGrowth.png](assets/mapGrowth.png)

–¢–∞–±–ª–∏—Ü—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –≥–ª—É–±–∏–Ω—É localDept.  –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å directory –ø—Ä–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã (localDepth == globalDepth)

# –ü—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä–æ–π –º–∞–ø—ã

–î–æ Go 1.24 –∫–∞—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞–ª–∏ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

- –ë–∞–∫–µ—Ç—ã: –∫–ª—é—á–∏ —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ `–±–∞–∫–µ—Ç–∞—Ö` (–≥—Ä—É–ø–ø–∞—Ö –ø–æ 8 –∑–∞–ø–∏—Å–µ–π).

- –¶–µ–ø–æ—á–∫–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è: –µ—Å–ª–∏ –±–∞–∫–µ—Ç –∑–∞–ø–æ–ª–Ω—è–ª—Å—è, –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –±–∞–∫–µ—Ç—ã `–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è`, —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–∞–∫ —Ü–µ–ø–æ—á–∫–∞.

- High order bits: —É –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –±—ã–ª –∫—Ä–æ—à–µ—á–Ω—ã–π `tophash` (8 –±–∏—Ç —Ö–µ—à–∞ –∫–ª—é—á–∞), —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–æ–≤–ø–∞–¥–∞—é—â–∏–µ –∫–ª—é—á–∏.

- –ü—Ä–æ–≤–µ—Ä–∫–∞ HOB –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ, –Ω–æ –∏–º–µ–ª–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —à–µ—Ä–æ—Ö–æ–≤–∞—Ç–æ—Å—Ç–∏:

- –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –æ–∑–Ω–∞—á–∞–ª–æ –ø—Ä—ã–∂–∫–∏ –≤ –ø–∞–º—è—Ç–∏ (–ø—Ä–∏–≤–µ—Ç, –ø—Ä–æ–º–∞—Ö–∏ –∫—ç—à–∞!).

- –†–∞–∑–¥—É–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: –±–∞–∫–µ—Ç—ã –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—ä–µ–¥–∞–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.

- –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –æ–∑–Ω–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ. –û–π.

# –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –º–∞–ø—ã

–ü–æ–¥—ã—Ç–æ–∂–∏–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π map –≤ Go 1.24, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–π –Ω–∞ Swiss Table:

- **–ë—ã—Å—Ç—Ä–æ–µ –æ—Ç—Å–µ–∏–≤–∞–Ω–∏–µ**¬†–ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–±—Ä–∞—Å—ã–≤–∞—Ç—å –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å–ª–æ—Ç—ã –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –∫–ª—é—á–∞–º.
    
- **–ü–æ–ª–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π**¬†–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–ª–ª–∏–∑–∏–π –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ H2.
    
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ tombstone**¬†–ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
    
- **–ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–µ –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ**¬†–º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ö–æ–¥–∏–º—ã—Ö –≥—Ä—É–ø–ø –∏ —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫ –∏ –≤—Å—Ç–∞–≤–∫—É —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    

–≠—Ç–∏ –º–µ—Ç–æ–¥—ã –Ω–∞—Ä—è–¥—É —Å –¥—Ä—É–≥–∏–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏ –¥–µ–ª–∞—é—Ç map –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–º:

- **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**¬†‚Äî –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–ª–æ—Ç–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ —Å–æ–∫—Ä–∞—â–∞—é—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–µ—à-–ø—Ä–æ–º–∞—Ö–æ–≤.
    
- **–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫**¬†‚Äî SIMD-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å—Ä–∞–∑—É 8 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ.
    
- **–ì–∏–±–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ**¬†‚Äî –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç —á–µ—Ä–µ–∑¬†**split**¬†–∏¬†**directory doubling**, –∞ —Ç–∞–∫–∂–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ–¥—Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ 1024 –≥—Ä—É–ø–ø —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.
# –ò—Å—Ç–æ—á–Ω–∏–∫–∏

–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ [–º–∞–ø—ã](https://cs.opensource.google/go/go/+/release-branch.go1.24:src/internal/runtime/maps/map.go)

–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–≥–æ –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏—è (probeSeq) [–ø–æ–∏—Å–∫–∞](https://cs.opensource.google/go/go/+/release-branch.go1.24:src/internal/runtime/maps/table.go)

–°—Ç–∞—Ç—å—è –Ω–∞ [—Ö–∞–±—Ä–µ](https://habr.com/ru/companies/simbirsoft/articles/899180/), —Å –∫–æ—Å—è–∫–æ–º, –ø—Ä–æ –≥—Ä—É–ø–ø—ã –¥–ª—è –æ–±—Ö–æ–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ –ª–∏–Ω–µ–π–Ω–æ–µ –∑–æ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ("–ª–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–±–∏–Ω–≥", –∫–∞–∫ –æ–Ω –Ω–∞–∑–≤–∞–Ω –≤ —Å—Ç–∞—Ç—å–µ), –∞ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω—ã–π.